<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Roboto font embed -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700" rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">
    
    <title>Socket.io</title>
</head>
<body>

    <main class="container">

        <div class="row">
            <h1>AFP News Feed</h1>

                <div class="row">
                    <div class="columns">
                        <label for="room-select">Topic</label>
                        <select class="u-full-width" id="room-select">
                          <option value="sport">Sport</option>
                          <option value="politique">Politique</option>
                          <option value="films">Cinéma</option>
                        </select>
                    </div>
                </div>


                <form action="" name="broadcast-form" id="broadcast-section">
                    <div class="row">
                        <div class="six columns">
                            <label for="message">Message à envoyer</label>
                            <input class="u-full-width" type="text" placeholder="Votre message" id="message" name="message" required/>
                        </div>
    
                        <div class="six columns">
                            <label for="broadcast-room-select">Topic sur lequel envoyer</label>
                            <select class="u-full-width" id="room-select" name="topic">
                              <option value="sport">Sport</option>
                              <option value="politique">Politique</option>
                              <option value="films">Cinéma</option>
                            </select>
                        </div>
                    </div>
    
                    <div class="row">
                        <div class="columns">
                            <form action="" id="form-message">
                                <button>Envoyer</button>
                            </form>
                        </div>
                    </div>
                </form>
                
                <ul id="list">

                </ul>
    
        </div>
        


    </main>
    
    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js" integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh" crossorigin="anonymous"></script>
    
    <script>
        const socket = io('http://localhost:3000');
        const list = document.getElementById('list');

        // écoute du socket
        socket.on('message', function(msg){
            console.log('Received', msg);
            let li = document.createElement('li');
            li.textContent = msg;
            list.appendChild(li);
        });

        let selectRoom = document.getElementById('room-select');
        let form = document.getElementById('broadcast-section');
        let input = document.getElementById('input');
        let prevRoom = '';

        /*
        ROOM SELECTION
        */
       selectRoom.addEventListener('change', (e) => {
            let room = e.target.value;
            socket.emit('join', prevRoom, room);
            prevRoom = room;
            list.innerHTML = '';
       })

        form.addEventListener('submit', (e) => {
            e.preventDefault();

            let data = document.forms['broadcast-form'];

            socket.emit('message', {
                room: data['room-select'].value,
                message: data['message'].value
            });
        });
    </script>
</body>
</html>